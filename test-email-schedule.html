<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮件定时发送测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background: #0056b3; }
        .button.danger { background: #dc3545; }
        .button.success { background: #28a745; }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .time-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>邮件定时发送测试工具</h1>
        <p>这个工具可以帮助你测试和调试邮件定时发送功能</p>
        
        <div class="time-display" id="currentTime"></div>
        
        <div>
            <button class="button" onclick="checkStatus()">检查系统状态</button>
            <button class="button" onclick="setTestTime()">设置测试时间</button>
            <button class="button success" onclick="triggerManual()">手动触发</button>
            <button class="button danger" onclick="resetToday()">重置今日记录</button>
        </div>
    </div>

    <div class="card">
        <h2>系统状态</h2>
        <div id="statusDisplay"></div>
    </div>

    <div class="card">
        <h2>操作日志</h2>
        <div class="log" id="logDisplay"></div>
    </div>

    <script>
        function updateTime() {
            const now = new Date();
            const beijingTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Shanghai" }));
            const timeString = beijingTime.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = `当前北京时间: ${timeString}`;
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logDisplay');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="status ${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = { method };
                if (body) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(endpoint, options);
                const data = await response.json();
                
                if (data.success) {
                    return data.data;
                } else {
                    throw new Error(data.error || 'API调用失败');
                }
            } catch (error) {
                log(`API错误: ${error.message}`, 'error');
                return null;
            }
        }

        async function checkStatus() {
            log('检查系统状态...', 'info');
            const data = await apiCall('/api/debug/email-status');
            
            if (data) {
                const statusDiv = document.getElementById('statusDisplay');
                const config = data.emailConfig;
                const timeMatch = data.timeMatchInfo;
                
                statusDiv.innerHTML = `
                    <div class="status ${data.systemStatus.readyToSend ? 'success' : 'error'}">
                        系统状态: ${data.systemStatus.readyToSend ? '✅ 就绪' : '❌ 未就绪'}
                    </div>
                    <div class="status info">
                        当前时间: ${data.currentTime.timeString} | 计划时间: ${config ? config.sendTime : '未设置'}
                    </div>
                    <div class="status ${data.alreadySentToday ? 'success' : 'info'}">
                        今日发送: ${data.alreadySentToday ? '✅ 已发送' : '❌ 未发送'}
                    </div>
                    <div class="status ${timeMatch && timeMatch.withinRange ? 'success' : 'info'}">
                        时间匹配: ${timeMatch ? (timeMatch.withinRange ? '✅ 在范围内' : `❌ 差${timeMatch.timeDifference}分钟`) : '无数据'}
                    </div>
                    <div class="status info">
                        邮箱数量: ${config ? config.emailCount : 0} | 启用状态: ${config ? (config.enabled ? '✅' : '❌') : '❌'}
                    </div>
                `;
                log('状态检查完成', 'success');
            }
        }

        async function setTestTime() {
            const now = new Date();
            const beijingTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Shanghai" }));
            beijingTime.setMinutes(beijingTime.getMinutes() + 3); // 3分钟后
            
            const timeString = beijingTime.getHours().toString().padStart(2, '0') + ':' + 
                              beijingTime.getMinutes().toString().padStart(2, '0');
            
            log(`建议设置发送时间为: ${timeString} (3分钟后)`, 'info');
            log('请到邮件管理页面手动设置这个时间', 'info');
        }

        async function triggerManual() {
            log('手动触发邮件检查...', 'info');
            const result = await apiCall('/api/debug/trigger-email-check', 'POST');
            if (result) {
                log('手动触发成功', 'success');
            }
        }

        async function resetToday() {
            if (confirm('确定要重置今日邮件发送记录吗？')) {
                log('重置今日发送记录...', 'info');
                const result = await apiCall('/api/debug/reset-email-sent', 'POST');
                if (result) {
                    log('重置成功，现在可以重新测试发送', 'success');
                    setTimeout(checkStatus, 1000);
                }
            }
        }

        // 页面加载时初始化
        window.onload = function() {
            updateTime();
            checkStatus();
            log('邮件定时发送测试工具已加载', 'info');
        };

        // 每秒更新时间
        setInterval(updateTime, 1000);
        
        // 每30秒自动检查状态
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
